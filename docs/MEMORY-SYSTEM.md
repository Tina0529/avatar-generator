# Adaptive Confidence Memory System

面向儿童 AI 伙伴的自适应置信度记忆系统。

---

## 核心问题

传统 AI 记忆系统对所有信息一视同仁——记就记了，删就删了。但当用户是一个 10 岁的孩子时，这套逻辑会出问题：

- 孩子说"我喜欢篮球"，系统记住了。
- 第二天孩子说"篮球好无聊"，系统把旧记忆删掉，换成"不喜欢篮球"。
- 第三天孩子又说"我们去打篮球吧！"——系统一脸茫然。

孩子的喜好多变，很多话只是一时兴起。**直接覆盖是错误的**，但**完全不更新也是错误的**。

---

## 设计哲学

**信任首次表达，对矛盾保持耐心。**

具体来说：

1. **首次提及即信任** — 孩子说"我喜欢恐龙"，没有理由不信。置信度直接给满（1.0）。
2. **矛盾不等于否定** — 孩子说"恐龙没意思"，不代表他真的不喜欢了。可能只是今天心情不好。不删除，只是降低置信度。
3. **多次矛盾才遗忘** — 需要 4 次一致的矛盾信号，一条记忆才会真正消失。
4. **反转可以恢复** — 如果孩子又说"其实恐龙还是很酷"，被弱化的记忆会逐步恢复。
5. **事实与偏好分开处理** — "升五年级了"是事实，直接修正；"不喜欢数学了"是偏好，渐进弱化。

---

## 与其他方案的对比

| 特性 | 传统 KV 存储 | Mem0 / MemGPT | 本方案 |
|------|-------------|---------------|--------|
| 首次信息 | 直接存 | 直接存 | 直接存，置信度 1.0 |
| 矛盾信息 | 覆盖旧值 | 覆盖或追加 | **渐进弱化，不立即覆盖** |
| 多次矛盾 | 每次都覆盖 | 同上 | 逐步降低置信度直至遗忘 |
| 反转恢复 | 不可能 | 需要重新存 | **自动渐进恢复** |
| 事实 vs 偏好 | 不区分 | 不区分 | **分开处理** |
| Prompt 注入 | 全部注入 | 按相关性 | **按置信度分层注入** |
| 适合场景 | 通用 | 通用对话 | **儿童等情感多变的用户** |

---

## 置信度模型

### 参数

```
INIT            = 1.0    所有记忆的初始置信度
WEAKEN_DROP     = 0.25   每次矛盾信号降低的幅度
REINFORCE_BOOST = 0.2    被弱化后，每次一致信号恢复的幅度
CONFIRM_THRESHOLD = 0.6  高于此值 → 注入 prompt 的"确认区"
SHOW_THRESHOLD    = 0.3  低于此值 → 不注入 prompt，但保留在 DB 中
```

### 生命周期

```
1.0 ──────────── 首次提及，完全信任
 │
 │  weaken（矛盾）
 ▼
0.75 ─────────── 动摇，但仍在"确认区"
 │
 │  weaken（再次矛盾）
 ▼
0.5 ──────────── 进入"不确定区"，prompt 中标注"可能已经变了"
 │
 │  weaken（第三次矛盾）
 ▼
0.25 ─────────── 低于显示阈值，不再注入 prompt
 │
 │  weaken（第四次矛盾）
 ▼
0.0 ──────────── 自动删除
```

### 恢复路径

```
0.5 （被弱化过）
 │
 │  reinforce（再次提及）
 ▼
0.7 ──────────── 回到确认区
 │
 │  reinforce
 ▼
0.9 ──────────── 接近完全恢复
 │
 │  reinforce
 ▼
1.0 ──────────── 完全恢复
```

注意：主观型记忆每次恢复 +0.2（渐进），事实型记忆直接跳回 1.0。

---

## 信息分类与处理策略

### 事实型（Factual）

客观事实，有明确的对错。

| 事件 | 处理 |
|------|------|
| "我升五年级了" | `save_memory(is_factual=true)` → confidence 1.0 |
| "我转学了" | `update_memory` → 直接修正旧记忆 |
| "考了100分" | `save_memory(is_factual=true)` → confidence 1.0 |

分类 `event`、`learning` 默认为事实型。

### 主观型（Subjective）

个人感受和偏好，没有对错，可能随时变化。

| 事件 | 处理 |
|------|------|
| "我喜欢篮球" | `save_memory` → confidence 1.0（信任） |
| "篮球好无聊"（矛盾） | `weaken_memory` → 篮球记忆降低，不删除 |
| "其实篮球还行"（反转） | `save_memory` → reinforce，渐进恢复 |

分类 `preference`、`personality` 默认为主观型。

---

## 三层 Prompt 注入

记忆按置信度分层注入 System Prompt，让 AI 对不同确定程度的信息采取不同态度：

### 确认区（confidence >= 0.6）

```markdown
## 小狸记住的事
- [preference] 喜欢恐龙
- [event] 数学考了95分
- [personality] 性格开朗，爱交朋友
```

AI 可以自信地引用这些信息。

### 不确定区（0.3 ~ 0.6）

```markdown
## 小狸不太确定的事（主人曾说过相反的话，可能已经变了）
- [preference] 喜欢篮球
```

AI 会谨慎对待——不会说"你不是喜欢篮球吗"，而是可能用试探的方式确认。

### 隐藏区（< 0.3）

不注入 prompt。记忆仍保存在 IndexedDB 中，如果再次被提及可以恢复。

---

## 自动维护机制

除了置信度，系统还有定期维护能力：

| 机制 | 触发时机 | 行为 |
|------|---------|------|
| 情景记忆清理 | 每次启动对话 | 删除 30 天前的日志 |
| 语义记忆压缩 | 每次启动对话 | 每分类最多 20 条，淘汰低置信度 + 低访问的 |
| 相似去重 | 每次 save_memory | 同分类 + 关键词重叠 >= 50% 视为同一条 |
| 访问计数 | 每次 recall_memory | 记录访问频率，用于优先级排序 |

---

## 工具集

AI 通过 Function Calling 操作记忆系统：

| 工具 | 用途 | 适用场景 |
|------|------|---------|
| `save_memory` | 记住新信息 | 所有首次提及的信息 |
| `recall_memory` | 回忆信息 | 需要引用之前记住的内容 |
| `weaken_memory` | 弱化旧记忆 | 听到与已有记忆矛盾的主观表达 |
| `update_memory` | 直接修正 | 客观事实发生变化 |
| `forget_memory` | 彻底删除 | 记忆完全错误（极少使用） |

### AI 决策流程

```
孩子说了一句话
     │
     ├─ 新信息，没有矛盾 ──→ save_memory（首次即信任）
     │
     └─ 与已有记忆矛盾
          │
          ├─ 客观事实变了 ──→ update_memory（直接修正）
          │
          └─ 主观偏好变了 ──→ weaken_memory（渐进弱化，不覆盖）
                              + 可选 save_memory 记录新偏好
```

---

## 技术实现

- **存储**：浏览器 IndexedDB，纯前端，无服务器依赖
- **记忆结构**：每条记忆包含 `content`、`category`、`confidence`、`factual`、`mentions`、`accessCount`、`created`、`updated` 字段
- **三层架构**：Working Memory（Gemini 对话上下文）/ Episodic（每日日志）/ Semantic（长期事实 + 置信度）
- **Prompt 组合**：Boot 序列 Soul → 日期 → 用户画像 → 近期日志 → 记忆（分层）→ 技能 → 工具说明

---

## 适用范围

这套置信度机制不仅适用于儿童场景，也适用于：

- **情感陪伴类 AI** — 用户的情绪和偏好频繁波动
- **长期关系型 AI** — 需要跟踪用户多月甚至多年的变化
- **个性化推荐** — 避免因一次偶然行为就改变用户画像
- **任何需要区分"稳定特征"和"临时状态"的系统**
